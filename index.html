<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Consultas Campo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;}
        .container {max-width:1200px;margin:0 auto;padding:20px;}
        .card {background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);padding:30px;margin-bottom:20px;}
        .header {text-align:center;color:#2d3748;margin-bottom:30px;}
        .login-form {max-width:400px;margin:0 auto;}
        .form-group {margin-bottom:20px;}
        label {display:block;margin-bottom:5px;font-weight:600;color:#4a5568;}
        input[type="text"],input[type="password"],select {width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;transition:border-color 0.3s;}
        input[type="text"]:focus,input[type="password"]:focus,select:focus {outline:none;border-color:#667eea;}
        .btn {background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;transition:transform 0.2s;width:100%;margin-top:10px;}
        .btn:hover {transform:translateY(-2px);}
        .btn-secondary {background:#4299e1;margin-right:10px;width:auto;min-width:120px;}
        .btn-danger {background:#e53e3e;}
        .search-section {display:none;}
        .search-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;}
        .result-card {background:#f7fafc;border:2px solid #e2e8f0;border-radius:12px;padding:20px;margin-top:20px;}
        .result-header {font-size:18px;font-weight:600;color:#2d3748;margin-bottom:15px;}
        .result-item {margin-bottom:10px;padding:5px 0;border-bottom:1px solid #e2e8f0;}
        .result-label {font-weight:600;color:#4a5568;}
        .action-buttons {display:flex;flex-wrap:wrap;gap:10px;margin-top:15px;}
        .admin-section {display:none;}
        .file-upload {border:2px dashed #cbd5e0;border-radius:12px;padding:30px;text-align:center;margin-bottom:20px;transition:border-color 0.3s;}
        .file-upload:hover {border-color:#667eea;}
        .user-info {position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.9);padding:10px 15px;border-radius:8px;}
        .hidden {display:none !important;}
        .suggestions {position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e2e8f0;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;}
        .suggestion-item {padding:10px;cursor:pointer;border-bottom:1px solid #f1f5f9;}
        .suggestion-item:hover {background:#f8fafc;}
        .search-container {position:relative;}
        .modal {display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);}
        .modal-content {background-color:white;margin:2% auto;padding:20px;border-radius:15px;width:90%;max-width:1000px;max-height:90%;overflow-y:auto;}
        .close {color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;}
        .close:hover {color:#000;}
        .charts-container {display:grid;grid-template-columns:1fr;gap:30px;margin-top:20px;}
        .chart-card {background:#f8fafc;border-radius:12px;padding:20px;}
        .chart-title {font-size:18px;font-weight:600;color:#2d3748;margin-bottom:15px;text-align:center;}
        .chart-container {position:relative;height:400px;}
        @media (max-width:768px) {
            .search-grid {grid-template-columns:1fr;}
            .action-buttons {flex-direction:column;}
            .btn-secondary {width:100%;margin:5px 0;}
            .modal-content {width:95%;margin:5% auto;padding:15px;}
            .chart-container {height:300px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-info hidden" id="userInfo">
            <span id="currentUser"></span>
            <button class="btn btn-danger" onclick="logout()" style="width:auto;padding:5px 10px;margin-left:10px;">Salir</button>
        </div>
        <div class="card" id="loginSection">
            <div class="header">
                <h1>üîç Sistema de Consultas Campo</h1>
                <p>Acceso para consultas offline</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" placeholder="Ingrese su usuario" value="admin">
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Usuarios de prueba: admin/admin123, usuario/user123, campo/campo123
                    </small>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ingrese su contrase√±a">
                </div>
                <button class="btn" onclick="login()">Iniciar Sesi√≥n</button>
            </div>
        </div>
        <div class="search-section" id="searchSection">
            <div class="card">
                <div class="header">
                    <h2>Consultar Informaci√≥n</h2>
                </div>
                <div class="search-grid">
                    <div class="form-group search-container">
                        <label for="searchCuenta">Buscar por Cuenta/Contrato:</label>
                        <input type="text" id="searchCuenta" placeholder="Ingrese n√∫mero de cuenta">
                        <div class="suggestions hidden" id="suggestionsCuenta"></div>
                    </div>
                    <div class="form-group search-container">
                        <label for="searchMedidor">Buscar por Medidor:</label>
                        <input type="text" id="searchMedidor" placeholder="Ingrese n√∫mero de medidor">
                        <div class="suggestions hidden" id="suggestionsMedidor"></div>
                    </div>
                    <div class="form-group search-container">
                        <label for="searchNombre">Buscar por Nombre:</label>
                        <input type="text" id="searchNombre" placeholder="Ingrese nombre del cliente">
                        <div class="suggestions hidden" id="suggestionsNombre"></div>
                    </div>
                </div>
                <button class="btn" onclick="buscarInformacion()">üîç Buscar</button>
                <div id="searchResults"></div>
            </div>
        </div>
        <div class="admin-section" id="adminSection">
            <div class="card">
                <div class="header">
                    <h2>Panel de Administraci√≥n</h2>
                </div>
                <div class="file-upload">
                    <h3>üìÅ Cargar Archivos Excel</h3>
                    <p>Arrastra tus archivos aqu√≠ o haz click para seleccionar</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple style="margin-top: 15px;">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="procesarArchivos()">üìä Procesar Archivos</button>
                    <button class="btn btn-danger" onclick="limpiarDatos()">üóëÔ∏è Limpiar Datos</button>
                </div>
            </div>
        </div>
    </div>
    <div id="chartsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarGraficas()">√ó</span>
            <h2 id="modalTitle">Gr√°ficas de Consumo y Lecturas</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">üìä Historial de Consumos (kWh)</div>
                    <div class="chart-container">
                        <canvas id="consumosChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">üìà Historial de Lecturas</div>
                    <div class="chart-container">
                        <canvas id="lecturasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://bsxllefnehbwkuqbelec.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzeGxsZWZuZWhid2t1cWJlbGVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQzMTksImV4cCI6MjA3MzA0MDMxOX0.Ma8elbehsraBPzPwSmntE78NaAfTgBKgDW_hMb-ohhg';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        // Ya no necesitamos almacenar todos los datos en una variable local
        // let consultasData = [];

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) {
                alert('Por favor ingrese usuario y contrase√±a');
                return;
            }
            try {
                const { data, error } = await supabaseClient
                    .from('usuarios')
                    .select('*')
                    .eq('usuario', username)
                    .eq('password', password)
                    .eq('activo', true)
                    .single();
                if (error || !data) {
                    alert('Usuario o contrase√±a incorrectos');
                    return;
                }
                currentUser = data;
                document.getElementById('currentUser').textContent = `Bienvenido, ${data.usuario}`;
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('loginSection').style.display = 'none';
                if (data.rol === 'administrador') {
                    document.getElementById('adminSection').style.display = 'block';
                }
                document.getElementById('searchSection').style.display = 'block';
                await supabaseClient.from('usuarios')
                    .update({ ultima_conexion: new Date().toISOString() })
                    .eq('id', data.id);
            } catch (err) {
                console.error('Error de login:', err);
                alert('Error de conexi√≥n');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // Funci√≥n de b√∫squeda mejorada para usar la API de Supabase directamente
        async function buscarInformacion() {
    const cuenta = document.getElementById('searchCuenta').value.trim();
    const medidor = document.getElementById('searchMedidor').value.trim();
    const nombre = document.getElementById('searchNombre').value.trim();
    
    if (!cuenta && !medidor && !nombre) {
        alert('Por favor ingrese al menos un criterio de b√∫squeda');
        return;
    }
    
    let query = supabaseClient.from('consultas_servicios').select('*');
    
    // Si hay una cuenta, medidor o nombre, aplicamos el filtro
    if (cuenta) {
        query = query.or(`CuentaContrato.ilike.%${cuenta}%`);
    }
    if (medidor) {
        query = query.or(`Medidor.ilike.%${medidor}%`);
    }
    if (nombre) {
        query = query.or(`NombreCliente.ilike.%${nombre}%`);
    }
    
    try {
        const { data, error } = await query;
        
        if (error) {
            console.error('Error en la b√∫squeda:', error.message);
            alert('Ocurri√≥ un error al buscar la informaci√≥n. Por favor, intente de nuevo.');
            return;
        }
        
        mostrarResultados(data || []);
        
    } catch (err) {
        console.error('Error en la b√∫squeda (catch):', err);
        alert('Ocurri√≥ un error al buscar la informaci√≥n. Por favor, intente de nuevo.');
    }
}
        function mostrarResultados(resultados) {
            const container = document.getElementById('searchResults');
            if (resultados.length === 0) {
                container.innerHTML = `
                    <div class="result-card">
                        <div class="result-header">‚ùå No se encontraron resultados</div>
                        <p>Intente con otros criterios de b√∫squeda</p>
                    </div>
                `;
                return;
            }
            let html = `<div class="result-header">‚úÖ Se encontraron ${resultados.length} resultado(s)</div>`;
            resultados.forEach((item, index) => {
                html += `
                    <div class="result-card">
                        <div class="result-header">Resultado ${index + 1}</div>
                        <div class="result-item">
                            <span class="result-label">Cuenta/Contrato:</span> ${item.CuentaContrato || 'N/A'}
                        </div>
                        <div class="result-item">
                            <span class="result-label">Medidor:</span> ${item.Medidor || 'N/A'}
                        </div>
                        <div class="result-item">
                            <span class="result-label">Cliente:</span> ${item.NombreCliente || 'N/A'}
                        </div>
                        <div class="result-item">
                            <span class="result-label">Comentario:</span> ${item.ComentarioGeneral || 'Sin comentarios'}
                        </div>
                        <div class="action-buttons">
                            ${item.Coordenadas ? `<button class="btn btn-secondary" onclick="abrirCoordenadas('${item.Coordenadas}')">üìç Ver Ubicaci√≥n</button>` : ''}
                            ${item.Coordenadasgis ? `<button class="btn btn-secondary" onclick="abrirCoordenadas('${item.Coordenadasgis}')">üó∫Ô∏è Ver GIS</button>` : ''}
                            ${item.FotoLink ? `<button class="btn btn-secondary" onclick="verFoto('${item.FotoLink}')">üì∏ Ver Foto</button>` : ''}
                            <button class="btn btn-secondary" onclick="verGraficas(
                                \`${item.Grafica || ''}\`, 
                                \`${item.NombreCliente || 'Cliente'}\`, 
                                \`${item.CuentaContrato || 'N/A'}\`
                            )">üìä Ver Gr√°ficas</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function abrirCoordenadas(coordenadas) {
            if (coordenadas) {
                const url = `https://www.google.com/maps?q=$${coordenadas}`;
                window.open(url, '_blank');
            }
        }

        function verFoto(link) {
            if (link) window.open(link, '_blank');
        }

        function parsearDatosGrafica(graficaData) {
            if (!graficaData || graficaData.trim() === '') {
                return { meses: [], lecturas: [], consumos: [] };
            }
            const meses = [], lecturas = [], consumos = [];
            const lineas = graficaData.split('\n').map(l => l.trim()).filter(l => l);
            for (const linea of lineas) {
                const match = linea.match(/^([A-Za-z]+)\.-?(\d+)(?:-(\d+))?/);
                if (match) {
                    const [, mes, lectura, consumo] = match;
                    meses.push(mes);
                    lecturas.push(parseInt(lectura));
                    if (consumo !== undefined) {
                        consumos.push(parseInt(consumo));
                    } else if (lecturas.length > 1) {
                        const consumoCalculado = lecturas[lecturas.length - 1] - lecturas[lecturas.length - 2];
                        consumos.push(Math.max(0, consumoCalculado));
                    } else {
                        consumos.push(0);
                    }
                }
            }
            return { meses, lecturas, consumos };
        }

        let consumosChart = null;
        let lecturasChart = null;
        
        // Ahora `verGraficas` recibe los datos directamente del HTML generado
        function verGraficas(graficaData, nombreCliente, cuentaContrato) {
            try {
                const modal = document.getElementById('chartsModal');
                const modalTitle = document.getElementById('modalTitle');
                modalTitle.textContent = `Gr√°ficas - ${nombreCliente} (Cuenta: ${cuentaContrato})`;
                modal.style.display = 'block';
                const datos = parsearDatosGrafica(graficaData);
                if (datos.meses.length === 0) {
                    // Datos de ejemplo si no hay informaci√≥n v√°lida
                    datos.meses = ['Ene.', 'Feb.', 'Mar.', 'Abr.', 'May.', 'Jun.'];
                    datos.lecturas = [1000, 1150, 1280, 1420, 1580, 1750];
                    datos.consumos = [0, 150, 130, 140, 160, 170];
                }
                if (consumosChart) consumosChart.destroy();
                if (lecturasChart) lecturasChart.destroy();
                setTimeout(() => { crearGraficas(datos); }, 100);
            } catch (error) {
                console.error('‚ùå Error mostrando gr√°ficas:', error);
                alert('Error mostrando las gr√°ficas. Por favor intente de nuevo.');
            }
        }

        function crearGraficas(datos) {
            try {
                const ctxConsumos = document.getElementById('consumosChart');
                if (ctxConsumos) {
                    // Instalamos el plugin de datalabels
                    Chart.register(ChartDataLabels);
                    consumosChart = new Chart(ctxConsumos, {
                        type: 'bar',
                        data: {
                            labels: datos.meses,
                            datasets: [{
                                label: 'Consumo (kWh)',
                                data: datos.consumos,
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 2,
                                borderRadius: 5,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.parsed.y} kWh`;
                                        }
                                    }
                                },
                                // Configuraci√≥n para ChartDataLabels
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => value > 0 ? value : '',
                                    color: '#4a5568',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Consumo (kWh)' } },
                                x: { title: { display: true, text: 'Mes' } }
                            }
                        }
                    });
                }
                const ctxLecturas = document.getElementById('lecturasChart');
                if (ctxLecturas) {
                    Chart.register(ChartDataLabels);
                    lecturasChart = new Chart(ctxLecturas, {
                        type: 'line',
                        data: {
                            labels: datos.meses,
                            datasets: [{
                                label: 'Lectura Acumulada',
                                data: datos.lecturas,
                                borderColor: 'rgba(118, 75, 162, 1)',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: 'rgba(118, 75, 162, 1)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} kWh`;
                                        }
                                    }
                                },
                                // Configuraci√≥n para ChartDataLabels
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => value.toLocaleString(),
                                    color: '#4a5568',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: { display: true, text: 'Lectura Acumulada (kWh)' },
                                    ticks: { callback: function(value) { return value.toLocaleString(); } }
                                },
                                x: { title: { display: true, text: 'Mes' } }
                            }
                        }
                    });
                }
                console.log('‚úÖ Gr√°ficas creadas exitosamente');
            } catch (error) {
                console.error('‚ùå Error creando gr√°ficas:', error);
            }
        }
        
        function cerrarGraficas() {
            document.getElementById('chartsModal').style.display = 'none';
            if (consumosChart) { consumosChart.destroy(); consumosChart = null; }
            if (lecturasChart) { lecturasChart.destroy(); lecturasChart = null; }
        }
        window.onclick = function(event) {
            const modal = document.getElementById('chartsModal');
            if (event.target === modal) cerrarGraficas();
        }

        async function procesarArchivos() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) {
                alert('Por favor seleccione al menos un archivo');
                return;
            }
            if (!confirm('¬øEst√° seguro de procesar los archivos? Esto actualizar√° todos los datos.')) return;
            try {
                alert(`Procesando ${files.length} archivo(s)... (Funci√≥n en desarrollo)`);
            } catch (err) {
                console.error('Error procesando archivos:', err);
                alert('Error procesando archivos');
            }
        }
        async function limpiarDatos() {
            if (!confirm('‚ö†Ô∏è ¬øEst√° seguro de eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) return;
            try {
                const { error } = await supabaseClient
                    .from('consultas_servicios')
                    .delete()
                    .neq('id', 0);
                if (error) throw error;
                document.getElementById('searchResults').innerHTML = '';
                alert('‚úÖ Todos los datos han sido eliminados');
            } catch (err) {
                console.error('Error limpiando datos:', err);
                alert('Error eliminando datos');
            }
        }
        
        // No se necesita el autocompletado en este momento ya que se busca en la base de datos
        // function setupAutoComplete() {}
        
        document.addEventListener('DOMContentLoaded', function() {
            // setupAutoComplete(); // Ya no es necesario
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</body>
</html>
